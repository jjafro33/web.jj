<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JJ Music Hub</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#121212; color:#fff; }
    header { background:#181818; padding:10px 20px; display:flex; align-items:center; justify-content:space-between; }
    .btn { padding:6px 12px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .btn:hover { background:#444; }
    #grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:16px; padding:20px; }
    .card { background:#181818; padding:10px; border-radius:6px; text-align:center; cursor:pointer; }
    .card img { width:100%; border-radius:6px; }
    .hidden { display:none; }
    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    .modal-box { background:#222; padding:20px; border-radius:6px; min-width:280px; }
    .playlist-item { padding:6px 8px; background:#333; margin:4px 0; border-radius:4px; cursor:pointer; }
    .playlist-item:hover { background:#444; }
    input { padding:6px; width:100%; margin-top:8px; border-radius:4px; border:none; }
    .flex-end { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
  </style>
</head>
<body>

<header>
  <h2>JJ Music Hub</h2>
  <div>
    <button class="btn" id="loginBtn">Login</button>
    <button class="btn hidden" id="logoutBtn">Logout</button>
  </div>
</header>

<main>
  <div id="grid"></div>
</main>

<!-- Playlist Modal -->
<div id="playlistModal" class="modal">
  <div class="modal-box">
    <h3>Add to Playlist</h3>
    <div id="playlistOptions"></div>
    <input id="newPlaylistName" placeholder="New playlist name">
    <div class="flex-end">
      <button class="btn" onclick="closePlaylistModal()">Cancel</button>
      <button class="btn" onclick="confirmAddToPlaylist()">Add</button>
    </div>
  </div>
</div>

<!-- Manage Playlists Modal -->
<div id="manageModal" class="modal">
  <div class="modal-box">
    <h3>Manage Playlists</h3>
    <div id="manageList"></div>
    <input id="renameInput" placeholder="Rename playlist">
    <div class="flex-end">
      <button class="btn" onclick="closeManageModal()">Done</button>
    </div>
  </div>
</div>

<script type="module">
  // === Firebase Setup ===
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR-KEY",
    authDomain: "YOUR-PROJECT.firebaseapp.com",
    projectId: "YOUR-PROJECT",
    storageBucket: "YOUR-PROJECT.appspot.com",
    messagingSenderId: "ID",
    appId: "ID"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let userPlaylists = [];
  let pendingTrackId = null;

  // === UI Elements ===
  const grid = document.getElementById('grid');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Dummy tracks
  const tracks = [
    { id:'1', title:'Track One', cover:'https://via.placeholder.com/150' },
    { id:'2', title:'Track Two', cover:'https://via.placeholder.com/150' },
    { id:'3', title:'Track Three', cover:'https://via.placeholder.com/150' }
  ];

  // === Render Cards ===
  function render() {
    grid.innerHTML = '';
    tracks.forEach(t => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<img src="${t.cover}"><p>${t.title}</p><button class="btn">Add to Playlist</button>`;
      card.querySelector('button').onclick = () => openAddToPlaylistMenu(t.id);
      grid.appendChild(card);
    });
  }
  render();

  // === Playlist Modal ===
  function openAddToPlaylistMenu(trackId) {
    if (!currentUser) { alert("Sign in first"); return; }
    pendingTrackId = trackId;
    const container = document.getElementById('playlistOptions');
    container.innerHTML = '';
    userPlaylists.forEach(pl => {
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.textContent = pl.name;
      div.onclick = () => { addTrackToPlaylist(pl.id, trackId); closePlaylistModal(); };
      container.appendChild(div);
    });
    document.getElementById('playlistModal').style.display = 'flex';
  }
  function closePlaylistModal() {
    document.getElementById('playlistModal').style.display = 'none';
    pendingTrackId = null;
  }
  async function confirmAddToPlaylist() {
    const name = document.getElementById('newPlaylistName').value.trim();
    if (name) {
      const id = 'pl_' + Date.now();
      const newPl = { id, name, tracks:[] };
      userPlaylists.push(newPl);
      await savePlaylists();
      if (pendingTrackId) addTrackToPlaylist(id, pendingTrackId);
    }
    closePlaylistModal();
  }

  // === Manage Modal ===
  function openManageModal() {
    const list = document.getElementById('manageList');
    list.innerHTML = '';
    userPlaylists.forEach((pl, i) => {
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.textContent = pl.name;
      div.onclick = () => {
        document.getElementById('renameInput').value = pl.name;
        document.getElementById('renameInput').onchange = async (e) => {
          pl.name = e.target.value;
          await savePlaylists();
          openManageModal();
        };
      };
      // Delete
      const del = document.createElement('button');
      del.textContent = 'X';
      del.className = 'btn';
      del.style.float = 'right';
      del.onclick = async (ev) => { ev.stopPropagation(); userPlaylists.splice(i,1); await savePlaylists(); openManageModal(); };
      div.appendChild(del);
      // Reorder
      if (i>0) {
        const up = document.createElement('button');
        up.textContent = 'â†‘';
        up.className = 'btn';
        up.style.float = 'right';
        up.onclick = async (ev) => { ev.stopPropagation(); [userPlaylists[i-1], userPlaylists[i]]=[userPlaylists[i],userPlaylists[i-1]]; await savePlaylists(); openManageModal(); };
        div.appendChild(up);
      }
      list.appendChild(div);
    });
    document.getElementById('manageModal').style.display = 'flex';
  }
  function closeManageModal() {
    document.getElementById('manageModal').style.display = 'none';
  }

  // === Playlist Logic ===
  async function addTrackToPlaylist(plId, trackId) {
    const pl = userPlaylists.find(p=>p.id===plId);
    if (pl && !pl.tracks.includes(trackId)) {
      pl.tracks.push(trackId);
      await savePlaylists();
    }
  }
  async function savePlaylists() {
    if (!currentUser) return;
    await setDoc(doc(db,'users',currentUser.uid), { playlists:userPlaylists }, { merge:true });
  }
  async function loadPlaylists(uid) {
    const snap = await getDoc(doc(db,'users',uid));
    userPlaylists = snap.exists() ? (snap.data().playlists||[]) : [];
  }

  // === Auth ===
  loginBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };
  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, async user => {
    currentUser = user;
    if (user) {
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      await loadPlaylists(user.uid);
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      userPlaylists = [];
    }
  });

  // === Debug button (open manage modal) ===
  document.addEventListener('keydown', e=>{
    if (e.key==='m') openManageModal();
  });
</script>
</body>
</html>
