<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JJ MUSIC HUB</title>
<meta name="description" content="Improved Spotify-like single-file web app with sidebar (Home/Search/Library), create playlist, liked songs, and full player." />
<style>
  /* -----------------------
     SpotiPro Single-file Styles
     Compact, modern, responsive
     ----------------------- */
  :root{
    --bg: #071018;
    --panel: #0f1720;
    --muted: #98a1ab;
    --text: #e6eef6;
    --accent: #1db954;
    --accent-2: #26f07a;
    --glass: rgba(255,255,255,0.03);
    --radius: 12px;
    --shadow: 0 12px 40px rgba(2,6,23,0.6);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:
    radial-gradient(900px 400px at 10% 0%, rgba(29,185,84,0.02), transparent), var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}

  a{color:inherit;text-decoration:none}
  button,input,select{font:inherit}

  /* App layout */
  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    grid-template-rows: 1fr auto; /* main + player */
    grid-template-areas: "sidebar main" "player player";
    gap: 18px;
    height: 100vh;
    padding: 18px;
  }

  /* Sidebar */
  .sidebar {
    grid-area: sidebar;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius: var(--radius);
    padding: 18px;
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: var(--shadow);
    display:flex;flex-direction:column;gap:12px;min-height:0;overflow:auto;
  }
  .sidebar-top {display:flex;align-items:center;gap:12px}
  .logo {width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-weight:800;color:#031;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 8px 20px rgba(29,185,84,0.12)}
  .app-name{font-weight:800}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .nav button{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer}
  .nav button.active, .nav button:hover{background:var(--glass);color:var(--text)}
  .search-box{display:flex;align-items:center;gap:8px;padding:8px;border-radius:12px;background:var(--panel);border:1px solid rgba(255,255,255,0.02)}
  .search-box input{background:transparent;border:0;outline:0;color:var(--text);width:100%}
  .create-playlist{margin-top:6px;padding:8px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021;font-weight:800;cursor:pointer}
  .library-list{margin-top:8px;overflow:auto}
  .lib-item{padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
  .lib-item:hover{background:rgba(255,255,255,0.02);color:var(--text)}

  /* Main */
  .main {grid-area:main;overflow:auto;padding:8px;min-height:0;display:flex;flex-direction:column;gap:16px}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
  .search-large{width:420px;padding:10px;border-radius:999px;background:var(--panel);border:1px solid rgba(255,255,255,0.02);color:var(--text)}
  .content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:10px;min-height:160px;transition:transform .16s,box-shadow .16s}
  .card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(0,0,0,0.6)}
  .card .art{height:110px;border-radius:10px;background:#222;display:flex;align-items:end;padding:10px;color:#fff;font-weight:700}
  .section-title{font-weight:800;margin:6px 0}
  .tracks-list{display:flex;flex-direction:column;gap:8px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
  .track-row{display:grid;grid-template-columns:44px 1fr 160px 80px;gap:12px;align-items:center;padding:10px;border-radius:8px;cursor:pointer;transition:background .12s}
  .track-row:hover{background:rgba(255,255,255,0.012)}
  .track-thumb{width:44px;height:44px;border-radius:8px;overflow:hidden;background:#111}
  .track-title{font-weight:700}
  .track-artist{color:var(--muted);font-size:.95rem}
  .track-album{color:var(--muted);text-align:right}
  .track-duration{text-align:right;color:var(--muted)}

  /* Player */
  .player{grid-area:player;border-radius:12px;padding:12px 18px;background:linear-gradient(180deg, rgba(0,0,0,0.5), rgba(0,0,0,0.7));border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 -8px 30px rgba(0,0,0,0.6)}
  .player-left{display:flex;gap:12px;align-items:center;min-width:240px}
  .player-art{width:64px;height:64px;border-radius:8px;background:#111;flex:0 0 64px}
  .player-meta{display:flex;flex-direction:column}
  .player-meta .song{font-weight:800}
  .player-meta .artist{color:var(--muted);font-size:.95rem}
  .player-center{flex:1;display:flex;flex-direction:column;align-items:center;gap:10px}
  .controls{display:flex;align-items:center;gap:12px}
  .btn{background:transparent;border:0;color:var(--text);cursor:pointer;font-size:18px;padding:8px;border-radius:8px}
  .btn.play{width:46px;height:46px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021;font-weight:800;display:grid;place-items:center}
  .btn:focus{outline:3px solid rgba(29,185,84,0.14);outline-offset:3px}
  .progress-wrap{width:100%;max-width:860px;display:flex;gap:12px;align-items:center}
  .time{color:var(--muted);font-size:.9rem;min-width:48px;text-align:center}
  .progress{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:99px;overflow:hidden;cursor:pointer}
  .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));}
  .player-right{display:flex;align-items:center;gap:12px;min-width:220px;justify-content:flex-end}
  .vol-wrap{display:flex;align-items:center;gap:8px}

  /* Modal (for creating playlist) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
  .modal{background:var(--panel);padding:18px;border-radius:12px;width:380px;border:1px solid rgba(255,255,255,0.03)}
  .modal h3{margin-bottom:8px}
  .modal input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-bottom:10px}

  /* Responsive */
  @media (max-width:1000px){
    .app{grid-template-columns:1fr;grid-template-areas:"main" "player";padding:12px}
    .sidebar{display:none}
    .search-large{width:100%}
    .track-row{grid-template-columns:44px 1fr 120px 60px}
    .player-left{min-width:140px}
    .player-right{min-width:80px}
  }

  /* small helpers */
  .muted{color:var(--muted)}
  .small{font-size:.9rem}
  .hidden{display:none}
</style>
</head>
<body>
<div class="app" role="application" aria-label="SpotiPro music player">

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Main navigation">
    <div>
      <div class="sidebar-top">
        <div class="logo">J</div>
        <div>
          <div class="app-name">JJ MUSIC HUB</div>
          <div class="muted small">music & playlists</div>
        </div>
      </div>

      <nav class="nav" aria-label="Primary nav">
        <button id="navHome" class="active" aria-pressed="true">üè†Ô∏é Home</button>
        <button id="navSearch">üîçÔ∏é Search</button>
        <button id="navLibrary">üïÆ Your Library</button>
      </nav>

      <div class="search-box" style="margin-top:10px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg>
        <input id="sidebarSearch" type="search" placeholder="Search library..." aria-label="Sidebar search">
      </div>

      <button id="createPlaylistBtn" class="create-playlist">+ Create Playlist</button>

      <div style="font-weight:700;margin-top:12px">Your Library</div>
      <div class="library-list" id="libraryList" aria-label="Library items">
        <div class="lib-item" id="likedSongsBtn">üíö Liked Songs</div>
        <!-- user playlists will be appended here -->
      </div>
    </div>

    <div style="margin-top:auto">
      <div class="muted small">Signed in as <strong>User</strong></div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main" role="main">
    <div class="topbar">
      <div>
        <div class="greeting" id="pageTitle">Home</div>
        <div class="muted small">Discover & play</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <input id="mainSearch" class="search-large" placeholder="Search tracks, artists, albums" aria-label="Main search">
        <button id="upgradeBtn" class="btn small" title="Upgrade">Upgrade</button>
      </div>
    </div>

    <section id="homeView">
      <div class="section-title">Featured</div>
      <div class="content-grid" id="featuredGrid">
        <!-- cards populated by JS -->
      </div>

      <div style="height:8px"></div>

      <div class="section-title">Top Tracks</div>
      <div class="tracks-list" id="topTracksList">
        <!-- track rows populated by JS -->
      </div>
    </section>

    <section id="searchView" class="hidden" aria-hidden="true">
      <div class="section-title">Search results</div>
      <div class="tracks-list" id="searchResults"></div>
    </section>

    <section id="libraryView" class="hidden" aria-hidden="true">
      <div class="section-title">Your Playlists</div>
      <div id="userPlaylists" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:8px">
        <!-- user playlists rendered here -->
      </div>

      <div style="height:12px"></div>
      <div class="section-title">Liked Songs</div>
      <div class="tracks-list" id="likedList"></div>
    </section>
  </main>

  <!-- Player -->
  <footer class="player" role="contentinfo">
    <div class="player-left">
      <div class="player-art" id="playerArt" aria-hidden style="background-size:cover;background-position:center"></div>
      <div class="player-meta">
        <div class="song" id="playerSong">‚Äî</div>
        <div class="artist" id="playerArtist">‚Äî</div>
      </div>
    </div>

    <div class="player-center">
      <div class="controls" role="group" aria-label="Playback controls">
        <button id="shuffleBtn" class="btn" title="Shuffle">üîÄ</button>
        <button id="prevBtn" class="btn" title="Previous">‚èÆ</button>
        <button id="playBtn" class="btn play" title="Play / Pause">‚ñ∂</button>
        <button id="nextBtn" class="btn" title="Next">‚è≠</button>
        <button id="repeatBtn" class="btn" title="Repeat">üîÅ</button>
      </div>

      <div class="progress-wrap">
        <div class="time small muted" id="curTime">0:00</div>
        <div class="progress" id="progress" title="Seek">
          <i id="progressFill"></i>
        </div>
        <div class="time small muted" id="durTime">0:00</div>
      </div>
    </div>

    <div class="player-right">
      <div class="devices muted">Devices</div>
      <div class="vol-wrap">
        <button id="muteBtn" class="btn" title="Mute">üîä</button>
        <input id="volSlider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume">
      </div>
    </div>
  </footer>

</div>

<!-- modal for create playlist -->
<div id="modalBackdrop" class="modal-backdrop" style="display:none;align-items:center;justify-content:center">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Create playlist</h3>
    <input id="playlistName" placeholder="Playlist name">
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelCreate" class="btn">Cancel</button>
      <button id="confirmCreate" class="create-playlist">Create</button>
    </div>
  </div>
</div>

<!-- audio -->
<audio id="audio" preload="auto"></audio>

<script>
/* =========================
   SpotiPro ‚Äî App logic
   - Home, Search, Library views
   - Create playlist + add/remove tracks
   - Liked songs
   - Player: play/pause, next/prev, shuffle, repeat, progress, volume
   - LocalStorage persistence for liked + playlists
   ========================= */

const demoTracks = [
  { id: 't1', title: "MONICA", artist: "Anirudh Ravichander", album: "Coolie",  duration: "3:22", cover: "c.jpg", src: "c1.mp3" },
  { id: 't2', title: "THETHIRIYA", artist: "Sid Sriram", album: "Bhrammastra", duration: "4:05", cover: "t.jpg", src: "t1.mp3" },
  { id: 't3', title: "MUTHA MAZHAI", artist: "Dhee", album: "Thug Life", duration: "4:01", cover: "J.jpg", src: "m1.mp3" },
  { id: 't4', title: "Why This Kolaveri", artist: "Dhanush", album: "Kolaveri", duration: "3:21", cover: "https://i.scdn.co/image/ab67616d0000b2739c9b1f5a4b6e7c8d9e0f1a2b", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
  { id: 't5', title: "Enna Solla Pogirai", artist: "Shankar Mahadevan", album: "Enna", duration: "4:10", cover: "https://i.scdn.co/image/ab67616d0000b2735b4c6a7b8c9d0e1f2a3b4c5d", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" }
];

// DOM refs
const tracksListEl = document.getElementById('topTracksList');
const featuredGrid = document.getElementById('featuredGrid');
const searchResults = document.getElementById('searchResults');
const likedListEl = document.getElementById('likedList');
const userPlaylistsEl = document.getElementById('userPlaylists');
const libraryList = document.getElementById('libraryList');

const navHome = document.getElementById('navHome');
const navSearch = document.getElementById('navSearch');
const navLibrary = document.getElementById('navLibrary');

const homeView = document.getElementById('homeView');
const searchView = document.getElementById('searchView');
const libraryView = document.getElementById('libraryView');

const mainSearch = document.getElementById('mainSearch');
const sidebarSearch = document.getElementById('sidebarSearch');

const createPlaylistBtn = document.getElementById('createPlaylistBtn');
const modalBackdrop = document.getElementById('modalBackdrop');
const confirmCreate = document.getElementById('confirmCreate');
const cancelCreate = document.getElementById('cancelCreate');
const playlistNameInput = document.getElementById('playlistName');

const likedSongsBtn = document.getElementById('likedSongsBtn');

const playerArt = document.getElementById('playerArt');
const playerSong = document.getElementById('playerSong');
const playerArtist = document.getElementById('playerArtist');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const progress = document.getElementById('progress');
const progressFill = document.getElementById('progressFill');
const curTime = document.getElementById('curTime');
const durTime = document.getElementById('durTime');
const volSlider = document.getElementById('volSlider');
const muteBtn = document.getElementById('muteBtn');
const audio = document.getElementById('audio');
const pageTitle = document.getElementById('pageTitle');

// App state
let tracks = demoTracks.slice();
let currentIndex = 0;
let isPlaying = false;
let isShuffle = false;
let repeatMode = 'off';
let liked = JSON.parse(localStorage.getItem('spoti_liked') || '[]'); // array of track ids
let playlists = JSON.parse(localStorage.getItem('spoti_playlists') || '[]'); // {name, id, tracks:[]}
let filteredIndices = tracks.map((_,i)=>i);

// helpers
const byId = id => document.getElementById(id);
function saveState(){
  localStorage.setItem('spoti_liked', JSON.stringify(liked));
  localStorage.setItem('spoti_playlists', JSON.stringify(playlists));
}
function formatTime(secs){
  if (!secs || isNaN(secs)) return '0:00';
  const s = Math.floor(secs % 60).toString().padStart(2,'0');
  const m = Math.floor(secs / 60);
  return `${m}:${s}`;
}

/* ---------- RENDERING ---------- */
function renderFeatured(){
  featuredGrid.innerHTML = '';
  // show first 4 tracks as feature cards (demo)
  tracks.slice(0,4).forEach(t => {
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `<div class="art" style="background-image:url('${t.cover}');background-size:cover;"></div><div class="title">${t.title}</div><div class="sub muted">${t.artist}</div>`;
    card.addEventListener('click', ()=>{
      const idx = tracks.findIndex(x=>x.id===t.id);
      selectAndPlay(idx);
    });
    featuredGrid.appendChild(card);
  });
}

function renderTracksList(containerEl, listIndices){
  containerEl.innerHTML = '';
  listIndices.forEach(idx => {
    const t = tracks[idx];
    const row = document.createElement('div');
    row.className = 'track-row';
    row.innerHTML = `
      <div class="track-thumb"><img src="${t.cover}" alt="${t.title}" style="width:100%;height:100%;object-fit:cover"></div>
      <div>
        <div class="track-title">${t.title}</div>
        <div class="track-artist muted">${t.artist}</div>
      </div>
      <div class="track-album">${t.album}</div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;">
        <div class="track-duration muted">${t.duration}</div>
        <button class="btn add-to-playlist" title="Add to playlist">‚ûï</button>
        <button class="btn like-btn" title="Like">${liked.includes(t.id) ? 'üíö' : 'ü§ç'}</button>
      </div>
    `;
    // click row to play
    row.addEventListener('click', (e)=>{
      // prevent clicks on buttons
      if (e.target.closest('.add-to-playlist') || e.target.closest('.like-btn')) return;
      selectAndPlay(idx);
    });
    // like button
    row.querySelector('.like-btn').addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleLike(t.id);
      renderAll(); // re-render to update like icons
    });
    // add to playlist
    row.querySelector('.add-to-playlist').addEventListener('click', (e)=>{
      e.stopPropagation();
      openAddToPlaylistModal(t.id);
    });

    containerEl.appendChild(row);
  });
}

function renderTopTracks(){
  const allIndices = tracks.map((_,i)=>i);
  renderTracksList(tracksListEl, allIndices);
}

function renderSearchResults(query){
  const q = (query||'').trim().toLowerCase();
  const results = [];
  tracks.forEach((t,i)=>{
    const hay = (t.title + ' ' + t.artist + ' ' + t.album).toLowerCase();
    if (!q || hay.includes(q)) results.push(i);
  });
  renderTracksList(searchResults, results);
}

function renderLiked(){
  const ids = liked;
  const idxs = ids.map(id => tracks.findIndex(t=>t.id===id)).filter(i=>i!==-1);
  renderTracksList(likedListEl, idxs);
}

function renderPlaylists(){
  userPlaylistsEl.innerHTML = '';
  libraryList.querySelectorAll('.user-pl-item')?.forEach(n=>n.remove());
  playlists.forEach(pl=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<div class="art" style="background-image:url('${tracks[0]?.cover||''}');background-size:cover"></div><div class="title">${pl.name}</div><div class="sub muted">${pl.tracks.length} songs</div>`;
    card.addEventListener('click', ()=> openPlaylistView(pl.id));
    userPlaylistsEl.appendChild(card);

    // also add small entry to library list
    const libItem = document.createElement('div');
    libItem.className = 'lib-item user-pl-item';
    libItem.textContent = 'üéµ ' + pl.name;
    libItem.addEventListener('click', ()=> openPlaylistView(pl.id));
    libraryList.appendChild(libItem);
  });

  // Liked item remains at top (already present)
}

/* ---------- PLAYLIST MODAL & ADD TRACK ---------- */
function openCreateModal(){
  playlistNameInput.value = '';
  modalBackdrop.style.display = 'flex';
  playlistNameInput.focus();
}
function closeCreateModal(){ modalBackdrop.style.display = 'none'; }
function createPlaylist(name){
  if (!name || !name.trim()) return;
  const id = 'pl_' + Date.now();
  playlists.push({ id, name: name.trim(), tracks: [] });
  saveState(); renderPlaylists();
  closeCreateModal();
}

function openAddToPlaylistModal(trackId){
  // simple prompt (to keep UI compact)
  const plNames = playlists.map((p,i)=>`${i+1}. ${p.name}`).join('\n') || '(no playlists)';
  const choice = prompt(`Add to a playlist:\n${plNames}\nEnter playlist number, or type new playlist name:`);
  if (!choice) return;
  const num = Number(choice);
  if (!isNaN(num) && playlists[num-1]){
    playlists[num-1].tracks.push(trackId);
    saveState();
    alert('Added to ' + playlists[num-1].name);
  } else {
    // create new playlist
    const newName = choice.trim();
    if (newName.length){
      const id = 'pl_' + Date.now();
      playlists.push({ id, name: newName, tracks: [trackId] });
      saveState(); renderPlaylists();
      alert('Created playlist "'+newName+'" and added track.');
    }
  }
}

/* ---------- OPEN PLAYLIST VIEW ---------- */
function openPlaylistView(plId){
  const pl = playlists.find(p=>p.id===plId);
  if (!pl) return;
  pageTitle.textContent = pl.name;
  // show playlist view in main area
  homeView.classList.add('hidden'); searchView.classList.add('hidden'); libraryView.classList.add('hidden');
  // create a temporary container to show playlist tracks
  const container = document.createElement('div');
  container.className = 'tracks-list';
  const idxs = pl.tracks.map(id => tracks.findIndex(t=>t.id===id)).filter(i=>i!==-1);
  renderTracksList(container, idxs);
  // clear main and show
  document.querySelector('.main').appendChild(container);
  // a simple way: show an alert-ish ephemeral section ‚Äî in production you'd swap views more cleanly
  setTimeout(()=>{ container.remove(); pageTitle.textContent = 'Your Library'; renderAll(); }, 1000*60); // auto-return after 60s
}

/* ---------- LIKED SONGS ---------- */
function toggleLike(trackId){
  const idx = liked.indexOf(trackId);
  if (idx === -1) liked.push(trackId);
  else liked.splice(idx,1);
  saveState();
}

/* ---------- PLAYER LOGIC ---------- */
function loadTrack(index, autoplay=true){
  const t = tracks[index];
  if (!t) return;
  currentIndex = index;
  audio.src = t.src;
  playerArt.style.backgroundImage = `url('${t.cover}')`;
  playerSong.textContent = t.title;
  playerArtist.textContent = t.artist;
  // update duration after loaded
  audio.onloadedmetadata = () => {
    durTime.textContent = formatTime(audio.duration);
    if (autoplay) playTrack();
  };
}

function playTrack(){
  audio.play().then(()=>{ isPlaying = true; playBtn.textContent = '‚è∏'; }).catch(()=>{ isPlaying=false; playBtn.textContent='‚ñ∂';});
}

function pauseTrack(){ audio.pause(); isPlaying=false; playBtn.textContent='‚ñ∂'; }

function selectAndPlay(index){
  loadTrack(index,true);
}

/* navigation */
function playNext(){
  if (repeatMode === 'one'){ loadTrack(currentIndex,true); return; }
  let pool = filteredIndices.length ? filteredIndices : tracks.map((_,i)=>i);
  if (isShuffle){
    currentIndex = pool[Math.floor(Math.random()*pool.length)];
  } else {
    const pos = pool.indexOf(currentIndex);
    let nextPos = pos + 1;
    if (nextPos >= pool.length){
      if (repeatMode === 'all') nextPos = 0;
      else { pauseTrack(); return; }
    }
    currentIndex = pool[nextPos];
  }
  loadTrack(currentIndex,true);
}

function playPrev(){
  if (audio.currentTime > 3){ audio.currentTime = 0; return; }
  let pool = filteredIndices.length ? filteredIndices : tracks.map((_,i)=>i);
  const pos = pool.indexOf(currentIndex);
  let prevPos = pos - 1;
  if (prevPos < 0) prevPos = (repeatMode==='all') ? pool.length-1 : 0;
  currentIndex = pool[prevPos];
  loadTrack(currentIndex,true);
}

/* progress */
audio.addEventListener('timeupdate', ()=>{
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  progressFill.style.width = pct + '%';
  curTime.textContent = formatTime(audio.currentTime);
});
progress.addEventListener('click', (e)=>{
  const rect = progress.getBoundingClientRect();
  const pct = (e.clientX - rect.left)/rect.width;
  if (audio.duration) audio.currentTime = pct * audio.duration;
});
audio.addEventListener('ended', ()=> playNext());

/* volume */
volSlider.addEventListener('input', ()=> { audio.volume = parseFloat(volSlider.value); muteBtn.textContent = audio.volume==0 ? 'üîá' : 'üîä'; });
muteBtn.addEventListener('click', ()=>{
  if (audio.volume > 0){ volSlider.dataset.prev = audio.volume; audio.volume = 0; volSlider.value = 0; muteBtn.textContent='üîá'; }
  else { const prev = parseFloat(volSlider.dataset.prev) || 1; audio.volume = prev; volSlider.value = prev; muteBtn.textContent='üîä'; }
});

/* control events */
playBtn.addEventListener('click', ()=> isPlaying ? pauseTrack() : playTrack());
nextBtn.addEventListener('click', ()=> { if (isShuffle) currentIndex = Math.floor(Math.random()*tracks.length); else currentIndex=(currentIndex+1)%tracks.length; loadTrack(currentIndex,true); });
prevBtn.addEventListener('click', ()=> playPrev());
shuffleBtn.addEventListener('click', ()=> { isShuffle = !isShuffle; shuffleBtn.style.color = isShuffle ? 'var(--accent)' : 'var(--text)'; });
repeatBtn.addEventListener('click', ()=>{
  if (repeatMode==='off'){ repeatMode='all'; repeatBtn.textContent='üîÅ'; repeatBtn.style.color='var(--accent)'; }
  else if (repeatMode==='all'){ repeatMode='one'; repeatBtn.textContent='üîÇ'; repeatBtn.style.color='var(--accent)'; }
  else { repeatMode='off'; repeatBtn.textContent='üîÅ'; repeatBtn.style.color='var(--text)'; }
});

/* keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if (e.code === 'Space'){ e.preventDefault(); isPlaying?pauseTrack():playTrack(); }
  if (e.code === 'ArrowRight') audio.currentTime = Math.min(audio.duration || 0, (audio.currentTime || 0) + 5);
  if (e.code === 'ArrowLeft') audio.currentTime = Math.max(0, (audio.currentTime || 0) - 5);
});

/* ---------- SEARCH & FILTER ---------- */
function applySearch(q){
  const query = (q||'').trim().toLowerCase();
  if (!query){
    filteredIndices = [];
    renderTopTracks();
    return;
  }
  const results = [];
  tracks.forEach((t,i)=>{
    if ((t.title + ' ' + t.artist + ' ' + t.album).toLowerCase().includes(query)) results.push(i);
  });
  filteredIndices = results.slice();
  // render search view
  renderSearchResults(query);
}
mainSearch.addEventListener('input', (e)=> { applySearch(e.target.value); showView('search'); });
sidebarSearch.addEventListener('input', (e)=> applySearch(e.target.value));

/* ---------- NAVIGATION HANDLERS ---------- */
function setActiveNav(btn){
  [navHome,navSearch,navLibrary].forEach(b=> b.classList.remove('active'));
  btn.classList.add('active');
}
function showView(view){
  // view: 'home'|'search'|'library'
  pageTitle.textContent = view==='home'?'Home': view==='search'?'Search' : 'Your Library';
  homeView.classList.toggle('hidden', view!=='home');
  searchView.classList.toggle('hidden', view!=='search');
  libraryView.classList.toggle('hidden', view!=='library');
  // update active nav
  if (view==='home'){ setActiveNav(navHome); navHome.setAttribute('aria-pressed','true'); navSearch.setAttribute('aria-pressed','false'); navLibrary.setAttribute('aria-pressed','false'); }
  if (view==='search'){ setActiveNav(navSearch); navHome.setAttribute('aria-pressed','false'); navSearch.setAttribute('aria-pressed','true'); navLibrary.setAttribute('aria-pressed','false'); }
  if (view==='library'){ setActiveNav(navLibrary); navHome.setAttribute('aria-pressed','false'); navSearch.setAttribute('aria-pressed','false'); navLibrary.setAttribute('aria-pressed','true'); }
}

navHome.addEventListener('click', ()=> { showView('home'); renderAll(); });
navSearch.addEventListener('click', ()=> { showView('search'); mainSearch.focus(); renderSearchResults(mainSearch.value); });
navLibrary.addEventListener('click', ()=> { showView('library'); renderPlaylists(); renderLiked(); });

/* create playlist modal */
createPlaylistBtn.addEventListener('click', openCreateModal);
cancelCreate.addEventListener('click', closeCreateModal);
confirmCreate.addEventListener('click', ()=> { createPlaylist(playlistNameInput.value); });

/* liked songs quick open */
likedSongsBtn.addEventListener('click', ()=> { showView('library'); renderLiked(); window.scrollTo({top:document.querySelector('#libraryView').offsetTop,behavior:'smooth'}); });

/* Open add-to-playlist prompt uses prompt() to keep file single and light */

/* ---------- RENDER WRAPPER ---------- */
function renderAll(){
  renderFeatured();
  renderTopTracks();
  renderPlaylists();
  renderLiked();
  // ensure progress/duration reset if no audio loaded
  if (!audio.src) { curTime.textContent='0:00'; durTime.textContent='0:00'; }
}

/* initial renders */
renderAll();
loadTrack(0,false); // load first but don't autoplay

</script>
</body>
</html>
